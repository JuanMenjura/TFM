CREATE OR REPLACE TABLE `sandbox_bancaseguros.JJMC_FRAUDE_MASCOTAS` AS

-- Obtener los siniestros
WITH SINIESTROS AS 
(
  SELECT DISTINCT
    FECHA_SUSCRIPCION,
    FECHA_SINIESTRO,
    KEY_ID_BENEFICIARIO,
    CODIGO_RIESGO,
    NUMERO_SINIESTRO,
    CODIGO_CAUSA,
    CAST(LIQUIDADO_BOLIVAR AS INT64) AS LIQUIDADO_BOLIVAR,
    CODIGO_CANAL,
    CODIGO_COBERTURA,
    MUNICIPIO_SINIESTRO,
    MARCA_REFERIDO,
    EXPEDIENTE,
    NUMERO_POLIZA,
    FORMAT_DATE('%Y%m', FECHA_SUSCRIPCION) AS ANIO_MES_SUSCRIPCION,
    CONCAT(CAST(KEY_ID_BENEFICIARIO AS STRING), '_', FORMAT_DATE('%Y%m', FECHA_SUSCRIPCION)) AS CONCAT_KEY_BENEFICIARIO
  FROM 
    `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros`
  WHERE
    CODIGO_PRODUCTO = 103
  AND
    CODIGO_SUBPRODUCTO = 348  
),

-- Obtener información de riesgo
RIESGO AS 
(
  SELECT DISTINCT
    tipo_riesgo,
    tipo_evento,
    numero_siniestro
  FROM
    `sb-ecosistemaanalitico-lago.bi_prod.t_stellent_lineas_agiles`
),

-- Obtener información de los clientes
CLIENTES AS 
(
  SELECT DISTINCT
    CREDITO_DIGITAL,
    CREDITO_FIJO_COMERCIAL,
    CREDITO_FIJO_LIBRANZA,
    CREDITO_HIPOTECARIO,
    CREDITO_VEHICULO,
    CDT,
    CUENTA_AHORROS,
    CUENTA_CORRIENTE,
    INGRESO_2,
    SEGMENTO_2,
    SUCURSAL,
    GENERO,
    ESTADO_CIVIL,
    ESTRATO,
    NIVEL_EDUCACION,
    CLIENTE_BANCARIO,
    CLIENTE_DAVIPLATA,
    FECHA_NACIMIENTO,
    FORMAT_DATE('%Y%m', DATE_SUB(FECHA_CORTE, INTERVAL 1 DAY)) AS ANIO_MES_CORTE,
    CONCAT(CAST(KEY_ID AS STRING), '_', FORMAT_DATE('%Y%m', DATE_SUB(FECHA_CORTE, INTERVAL 1 DAY))) AS CONCAT_KEY_ID
  FROM
    `sb-ecosistemaanalitico-lago.davivienda.t_clientes_pn`
  WHERE 
    FECHA_CORTE >= '2020-07-01'
),

-- Obtener información de crédito
DATACREDITO AS 
(
  SELECT DISTINCT
    ACIERTA_PLUS,
    CAST(MAX(SALDO_TDC_MER) AS INT64) AS SALDO_TDC_MER,
    CAST(MAX(SALDO_ROT_MER) AS INT64) AS SALDO_ROT_MER,
    CAST(MAX(SALDO_CAB_MER) AS INT64) AS SALDO_CAB_MER,
    CAST(MAX(SALDO_HP_MER) AS INT64) AS SALDO_HP_MER,
    CAST(MAX(SALDO_OTROS_COMER_MER) AS INT64) AS SALDO_OTROS_COMER_MER,
    CAST(MAX(SALDO_VEH_MER) AS INT64) AS SALDO_VEH_MER,
    FORMAT_DATE('%Y%m', DATE_SUB(FECHA_CORTE, INTERVAL 1 DAY)) AS ANIO_MES_CORTE,
    CONCAT(CAST(KEY_ID AS STRING), '_', FORMAT_DATE('%Y%m', DATE_SUB(FECHA_CORTE, INTERVAL 1 DAY))) AS CONCAT_KEY_ID
  FROM
    `sb-ecosistemaanalitico-lago.davivienda.t_datacredito_bimestral2`
  WHERE
    FECHA_CORTE >= '2020-07-01'
  GROUP BY 
    ACIERTA_PLUS, FECHA_CORTE, KEY_ID  
)

-- Unir todas las tablas en la tabla final y calcular la edad
SELECT
  S.FECHA_SUSCRIPCION,
  S.FECHA_SINIESTRO,
  S.KEY_ID_BENEFICIARIO,
  S.CODIGO_RIESGO,
  S.NUMERO_SINIESTRO,
  S.CODIGO_CAUSA,
  S.LIQUIDADO_BOLIVAR,
  S.CODIGO_CANAL,
  S.CODIGO_COBERTURA,
  S.MUNICIPIO_SINIESTRO,
  S.MARCA_REFERIDO,
  S.EXPEDIENTE,
  S.NUMERO_POLIZA,
  R.tipo_riesgo,
  R.tipo_evento,
  C.CREDITO_DIGITAL,
  C.CREDITO_FIJO_COMERCIAL,
  C.CREDITO_FIJO_LIBRANZA,
  C.CREDITO_HIPOTECARIO,
  C.CREDITO_VEHICULO,
  C.CDT,
  C.CUENTA_AHORROS,
  C.CUENTA_CORRIENTE,
  C.INGRESO_2,
  C.SEGMENTO_2,
  C.SUCURSAL,
  C.GENERO,
  C.ESTADO_CIVIL,
  DATE_DIFF(DATE(S.FECHA_SUSCRIPCION), DATE(C.FECHA_NACIMIENTO), YEAR) AS EDAD,
  C.ESTRATO,
  C.NIVEL_EDUCACION,
  C.CLIENTE_BANCARIO,
  C.CLIENTE_DAVIPLATA,
  D.ACIERTA_PLUS,
  D.SALDO_TDC_MER,
  D.SALDO_ROT_MER,
  D.SALDO_CAB_MER,
  D.SALDO_HP_MER,
  D.SALDO_OTROS_COMER_MER,
  D.SALDO_VEH_MER
FROM
  SINIESTROS AS S
INNER JOIN RIESGO AS R 
ON S.NUMERO_SINIESTRO = R.numero_siniestro
INNER JOIN CLIENTES AS C 
ON S.CONCAT_KEY_BENEFICIARIO = C.CONCAT_KEY_ID
INNER JOIN DATACREDITO AS D 
ON S.CONCAT_KEY_BENEFICIARIO = D.CONCAT_KEY_ID

